<h2><%= room.roomName %></h2>


<img src="images/B40-logo-small.png">

<div id="messagesContainer" style="background:url('images/timeline.png');background-repeat:repeat-y;background-position:center;text-align:center">
</div>
<div id="newMessageForm">
    <textarea id="message" placeholder="Type prayer or response here..."></textarea>
    <br>
    <button id="postMessageButton">Send</button>
</div>

<script>
    var MessageModel = Backbone.Model.extend({
        urlRoot: '/message',
    });

    // var SailsCollection = Backbone.Collection.extend({
    //   sailsCollection: "",
    //   socket: null,
    //   sync: function(method, model, options) {
    //     var where = {};
    //     if (options.where) {
    //       where = {
    //         where : options.where
    //       }
    //     }
    //     if (typeof this.sailsCollection === "string" && this.salesCollection !== "") {
    //       this.socket = io.connect();
    //       this.socket.on("connect", _.bind(function() {
    //         this.socket.request("/" + this.sailsCollection, where, _.bind(function(users){
    //           this.set(users);
    //         }, this));
    //
    //         this.socket.on("message", _.bind(function(msg) {
    //           var m = msg.verb;
    //           if (m === "create" ) {
    //             this.add(msg.data);
    //           } else if ( m === "update" ) {
    //             this.get(msg.id).set(msg.data);
    //           } else if (m === "destroy") {
    //             this.remove(this.get(msg.id));
    //           }
    //         }, this));
    //       }, this));
    //     } else {
    //       console.log("Error: Cannot retrieve models because property 'sailsCollection' not set on the collection");
    //     }
    //   }
    // });
    //
    // var MessageCollection = SailsCollection.extend({
    //     sailsCollection: 'messages',
    //     model: MessageModel,
    // });

    var MessageCollection = Backbone.Collection.extend({
        url: '/message',
        model: MessageModel,
    });
    
    var messages = new MessageCollection();
    messages.fetch();

    $("#postMessageButton").click(function(){
        var messageText = $("#message").val();
        messages.create({message: messageText}, {wait: true});
        $("#message").val("");
    });
    
    _.templateSettings = {
        interpolate : /\{\{(.+?)\}\}/g
    };
    var MessagesView = Backbone.View.extend({
        el: '#messagesContainer',
        initialize: function () {
            this.collection.on('add', this.render, this);
            this.render();
        },
        template: _.template("<div><p>{{ message }}</p></div>"),
            render: function () {
                this.$el.html("");
                this.collection.each(function(msg){
                    this.$el.append(this.template(msg.toJSON()));
                }, this)
        }
    });
    
    var start = new Date('<%= room.start %>');
    var days = [];
    
    var daysBetween = function( date1, date2 ) {
      //Get 1 day in milliseconds
      var one_day=1000*60*60*24;

      // Convert both dates to milliseconds
      var date1_ms = date1.getTime();
      var date2_ms = date2.getTime();

      // Calculate the difference in milliseconds
      var difference_ms = date2_ms - date1_ms;
    
      // Convert back to days and return
      return Math.round(difference_ms/one_day); 
    }
    
    messages.each(function(msg) {
      var day = daysBetween(start, new Date(msg.get('createdAt')));
      console.log(day);
    });
    for (var i = 0; i < 40; i++) {
      
    }
    
    // var mView = new MessagesView({collection: messages});
</script>